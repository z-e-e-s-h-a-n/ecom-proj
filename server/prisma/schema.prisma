// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DB_URI")
}

//
// ENUMS
//

enum UserRole {
  admin
  customer
  productManager
  inventoryManager
  orderManager
  shippingManager
  supportAgent
  marketingManager
  financeManager
}

enum OtpPurpose {
  setPassword
  resetPassword
  verifyIdentifier
  changeIdentifier
  enableMfa
  disableMfa
  verifyMfa
}

enum OtpType {
  otp
  token
}

enum MfaMethod {
  email
  sms
  whatsapp
  authApp
}

enum ProductStatus {
  draft
  active
  archived
}

enum InventoryStatus {
  inStock
  lowStock
  outOfStock
  preOrder
}

enum OrderStatus {
  pending
  confirmed
  processing
  shipped
  delivered
  cancelled
  refunded
}

enum PaymentStatus {
  pending
  processing
  completed
  failed
  refunded
  cancelled
}

enum RefundStatus {
  requested
  approved
  rejected
  processed
}

enum ReturnExchangeType {
  return
  exchange
}

enum ReturnExchangeStatus {
  pending
  approved
  rejected
  awaiting_return
  in_transit
  received
  refunded
  exchanged
}

enum ReturnShippingResponsibility {
  customer
  seller
}

enum ShipmentStatus {
  pending
  processing
  readyToShip
  shipped
  inTransit
  delivered
  failed
  cancelled
}

enum ShippingMethod {
  standard
  express
  overnight
  pickup
  international
}

enum AddressType {
  billing
  shipping
}

enum AddressLabel {
  home
  work
  other
}

enum CouponType {
  percentage
  fixedAmount
  freeShipping
}

enum MediaType {
  image
  video
  pdf
}

enum ReviewStatus {
  pending
  approved
  rejected
}

enum NotificationType {
  email
  sms
  whatsapp
  inApp
}

enum NotificationStatus {
  pending
  sent
  failed
  read
}

enum AttributeType {
  color
  select
  radio
  image
  text
}

enum EngagementType {
  cart
  wishlist
  compare
  viewed
}

enum ThemeType {
  dark
  light
  system
}

enum WeightUnit {
  g
  kg
}

enum DimensionUnit {
  cm
  inch
}

enum LoyaltyTransactionType {
  earn
  redeem
}

enum LoyaltyAction {
  order
  review
  referral
  signup
  firstPurchase
}

enum AuditAction {
  // Auth & Security
  userSignup
  userLogin
  userPasswordReset
  userPasswordChange
  mfaEnabled
  mfaDisabled

  // User Management
  userProfileUpdated
  roleAssigned
  roleRevoked

  // Orders
  orderCreated
  orderCancelled
  orderShipped
  orderDelivered
  orderRefunded

  // Shipment
  shipmentCreated
  shipmentUpdated
  shipmentCancelled

  // Payments
  paymentCompleted
  paymentFailed
  paymentRefunded

  // Products & Catalog
  productCreated
  productUpdated
  productDeleted
  categoryCreated
  categoryUpdated
  categoryDeleted

  // Reviews
  reviewSubmitted
  reviewApproved
  reviewRejected

  // Coupons
  couponCreated
  couponUpdated
  couponDeleted
  couponApplied

  // Loyalty
  loyaltyPointsEarned
  loyaltyPointsRedeemed

  // Notifications
  notificationSent

  // Settings
  settingUpdated
}

enum AuditSeverity {
  info
  warning
  critical
}

//
// AUTH MODELS
//

model User {
  id          String  @id @default(ulid())
  username    String? @unique
  password    String?
  firstName   String
  lastName    String?
  displayName String
  imageUrl    String?

  // Contact
  email           String? @unique
  phone           String? @unique
  isEmailVerified Boolean @default(false)
  isPhoneVerified Boolean @default(false)
  loyaltyPoints   Int     @default(0)

  // Status
  lastLoginAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Referral  // todo IMPLEMENT Referrals Logic
  referralCode String  @unique
  referredById String?
  referredBy   User?   @relation("UserReferrals", fields: [referredById], references: [id])
  referrals    User[]  @relation("UserReferrals")

  // Relations
  refreshTokens   RefreshToken[]
  otps            Otp[]
  auditLogs       AuditLog[]
  roles           RoleAssignment[]
  securitySetting SecuritySetting?

  addresses                Address[]
  orders                   Order[]
  reviews                  Review[]
  notifications            Notification[]
  coupons                  UserCoupon[]
  productEngagements       ProductEngagement[]
  backupCodes              BackupCode[]
  loyaltyPointTransactions LoyaltyPointTransaction[]
  userPreferences          UserPreference[]
  refunds                  Refund[]

  initiatedReturnExchanges ReturnExchange[] @relation("ReturnExchangeInitiatedBy")
  approvedReturnExchanges  ReturnExchange[] @relation("ReturnExchangeApprovedBy")

  @@index([email])
  @@index([phone])
  @@index([username])
  @@index([referredById])
  @@index([email, isEmailVerified])
  @@index([phone, isPhoneVerified])
}

model RoleAssignment {
  id     String   @id @default(ulid())
  userId String
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   UserRole

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  revokedAt DateTime?

  @@unique([userId, role])
}

model SecuritySetting {
  id     String @id @default(ulid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  preferredMfa  MfaMethod?
  recoveryEmail String?
  recoveryPhone String?
  isMfaEnabled  Boolean    @default(false)
  loginAlerts   Boolean    @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isMfaEnabled])
}

model BackupCode {
  id        String    @id @default(ulid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String    @unique
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  expiresAt DateTime

  @@index([userId, usedAt])
}

model RefreshToken {
  id          String   @id @default(ulid())
  token       String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ip          String
  userAgent   String
  lastUsed    DateTime @default(now())
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  isActive    Boolean  @default(true)
  blacklisted Boolean  @default(false)

  @@index([userId])
  @@index([expiresAt])
  @@index([userId, expiresAt])
}

model Otp {
  id        String     @id @default(ulid())
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  purpose   OtpPurpose
  type      OtpType    @default(otp)
  secret    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([userId, purpose])
  @@index([expiresAt])
}

model AuditLog {
  id         String        @id @default(ulid())
  userId     String?
  user       User?         @relation(fields: [userId], references: [id])
  action     AuditAction
  severity   AuditSeverity @default(info)
  entityType String? // TODO AuditEntity make logic in types/prisma only can be a model name
  entityId   String?
  metadata   Json?
  createdAt  DateTime      @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@index([severity])
}

model Media {
  id        String    @id @default(ulid())
  type      MediaType
  url       String
  altText   String?
  caption   String?
  width     Int?
  height    Int?
  size      Int? // in bytes
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  // products Product[] @relation("ProductMedia")
  // variants ProductVariant[] @relation("VariantMedia")
  // categories Category[] @relation("CategoryMedia")
}

//
// ECOMMERCE MODELS
//

model Currency {
  id           String  @id @default(ulid())
  code         String  @db.VarChar(3)
  name         String
  symbol       String
  exchangeRate Decimal @db.Decimal(10, 2)
  isDefault    Boolean @default(false)
  decimalSep   String  @default(".")
  thousandSep  String  @default(",")
  country      String  @db.VarChar(2)

  orders        Order[]
  payments      Payment[]
  variants      VariantPricing[]
  shippingRates ShippingRate[]
  taxRates      TaxRate[]

  @@unique([code])
  @@unique([country])
  @@index([code])
  @@index([isDefault])
  @@index([country])
}

model Category {
  id          String     @id @default(ulid())
  title       String
  slug        String     @unique
  description String?
  imageUrl    String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Category[] @relation("CategoryHierarchy")
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?

  products Product[]

  attributes     AttributeDefinition[]     @relation("CategoryAttributes")
  specifications SpecificationDefinition[] @relation("CategorySpecifications")
  taxRates       TaxRate[]                 @relation("CategoryTaxRates")

  @@unique([parentId, title])
  @@index([parentId])
}

model Product {
  id          String   @id @default(ulid())
  title       String
  slug        String   @unique
  highlights  String?
  description String?
  images      String[]
  videoUrl    String?

  status ProductStatus @default(draft)

  metaTitle       String?
  metaDescription String?
  metaKeywords    String?

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: NoAction)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  variants       ProductVariant[]
  reviews        Review[]
  orderItems     OrderItem[]
  interactions   ProductEngagement[]
  specifications ProductSpecification[]
  attributes     ProductAttribute[]

  @@index([categoryId])
  @@index([status])
  @@index([slug])
  @@index([categoryId, status])
  @@index([deletedAt])
}

model ProductVariant {
  id        String  @id @default(ulid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  sku     String   @unique
  barcode String?
  images  String[]

  stock           Int             @default(0)
  reserved        Int             @default(0)
  inventoryStatus InventoryStatus @default(inStock)

  weight     VariantWeight?
  dimensions VariantDimensions?
  pricing    VariantPricing[]

  isActive  Boolean   @default(true)
  isDefault Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  orderItems         OrderItem[]
  productEngagements ProductEngagement[]
  attributes         VariantAttribute[]
  reviews            Review[]
  returnExchanges    ReturnExchangeVariant[]

  @@index([productId])
  @@index([sku])
  @@index([productId, isActive])
  @@index([productId, inventoryStatus])
}

model VariantWeight {
  id        String         @id @default(ulid())
  variantId String         @unique
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  value Decimal    @db.Decimal(10, 2)
  unit  WeightUnit @default(kg)
}

model VariantDimensions {
  id        String         @id @default(ulid())
  variantId String         @unique
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  length Decimal       @db.Decimal(10, 2)
  width  Decimal       @db.Decimal(10, 2)
  height Decimal       @db.Decimal(10, 2)
  unit   DimensionUnit @default(cm)
}

model VariantPricing {
  id        String         @id @default(ulid())
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  currencyId String
  currency   Currency @relation(fields: [currencyId], references: [id], onDelete: NoAction)

  basePrice Decimal  @db.Decimal(10, 2)
  salePrice Decimal? @db.Decimal(10, 2)
  costPrice Decimal  @db.Decimal(10, 2)

  @@unique([variantId, currencyId])
}

model AttributeDefinition {
  id         String        @id @default(ulid())
  name       String
  type       AttributeType
  options    String[]
  isRequired Boolean       @default(false)
  isDefault  Boolean       @default(false)
  categories Category[]    @relation("CategoryAttributes")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  productAttributes ProductAttribute[]

  @@unique([name, type])
}

model ProductAttribute {
  id           String              @id @default(ulid())
  productId    String
  product      Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  definitionId String
  definition   AttributeDefinition @relation(fields: [definitionId], references: [id])
  options      String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, definitionId])
  @@index([productId])
}

model VariantAttribute {
  id        String         @id @default(ulid())
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  name  String
  value String

  @@unique([variantId, name])
  @@index([variantId])
}

model SpecificationDefinition {
  id         String     @id @default(ulid())
  name       String
  options    String[]
  isRequired Boolean    @default(false)
  isDefault  Boolean    @default(false)
  categories Category[] @relation("CategorySpecifications")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([name])
}

model ProductSpecification {
  id        String  @id @default(ulid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  name  String
  value String

  @@unique([productId, name])
  @@index([productId])
}

model Address {
  id     String @id @default(ulid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName String
  lastName  String?
  street    String
  city      String
  state     String
  zip       String?
  country   String
  phone     String

  isDefault Boolean      @default(false)
  type      AddressType  @default(shipping)
  label     AddressLabel @default(home)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  billingOrders  Order[] @relation("BillingAddress")
  shippingOrders Order[] @relation("ShippingAddress")

  @@index([userId])
  @@index([isDefault])
  @@index([userId, type])
}

model Order {
  id     String @id @default(ulid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: NoAction)

  status OrderStatus @default(pending)

  subtotal       Decimal @db.Decimal(10, 2)
  taxAmount      Decimal @default(0) @db.Decimal(10, 2)
  shippingAmount Decimal @default(0) @db.Decimal(10, 2) // Todo add Shipment Details
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  total          Decimal @db.Decimal(10, 2)

  currencyId String
  currency   Currency @relation(fields: [currencyId], references: [id], onDelete: NoAction)

  shippingAddressId String
  shippingAddress   Address  @relation("ShippingAddress", fields: [shippingAddressId], references: [id], onDelete: Restrict)
  billingAddressId  String?
  billingAddress    Address? @relation("BillingAddress", fields: [billingAddressId], references: [id], onDelete: Restrict)

  taxRateId String
  taxRate   TaxRate @relation(fields: [taxRateId], references: [id])

  userCouponId String?
  userCoupon   UserCoupon? @relation(fields: [userCouponId], references: [id])

  customerNotes String?
  internalNotes String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  confirmedAt DateTime?
  shippedAt   DateTime?
  deliveredAt DateTime?
  cancelledAt DateTime?
  deletedAt   DateTime?

  items           OrderItem[]
  payments        Payment[]
  shipments       Shipment[]
  refunds         Refund[]
  returnExchanges ReturnExchange[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([createdAt, status])
  @@index([userId, status])
}

model OrderItem {
  id        String         @id @default(ulid())
  orderId   String
  order     Order          @relation(fields: [orderId], references: [id])
  productId String
  product   Product        @relation(fields: [productId], references: [id], onDelete: NoAction)
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: NoAction)

  name       String
  sku        String
  quantity   Int
  unitPrice  Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  returnExchanges ReturnExchangeItem[]

  @@unique([orderId, productId, variantId])
  @@unique([variantId, sku])
  @@index([orderId])
  @@index([productId])
  @@index([productId, variantId])
}

model PaymentMethod {
  id          String   @id @default(ulid())
  name        String
  code        String   @unique
  description String?
  imageUrl    String?
  meta        Json?
  countries   String[]
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id            String        @id @default(ulid())
  orderId       String
  order         Order         @relation(fields: [orderId], references: [id])
  methodId      String
  method        PaymentMethod @relation(fields: [methodId], references: [id])
  amount        Decimal       @db.Decimal(10, 2)
  currencyId    String
  currency      Currency      @relation(fields: [currencyId], references: [id])
  status        PaymentStatus @default(pending)
  transactionId String?
  gateway       String?
  gatewayData   Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?

  refunds Refund[]

  @@index([orderId])
  @@index([status])
  @@index([transactionId])
}

model Refund {
  id            String  @id @default(ulid())
  orderId       String
  order         Order   @relation(fields: [orderId], references: [id])
  paymentId     String
  payment       Payment @relation(fields: [paymentId], references: [id])
  processedById String?
  processedBy   User?   @relation(fields: [processedById], references: [id])

  status RefundStatus
  amount Decimal      @db.Decimal(10, 2)
  reason String
  notes  String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  returnExchanges ReturnExchange[]

  @@index([orderId])
  @@index([paymentId])
}

model ReturnExchangeItem {
  id               String         @id @default(cuid())
  returnExchangeId String
  orderItemId      String
  quantity         Int            @default(1)
  returnExchange   ReturnExchange @relation(fields: [returnExchangeId], references: [id])
  orderItem        OrderItem      @relation(fields: [orderItemId], references: [id])
}

model ReturnExchangeVariant {
  id               String         @id @default(cuid())
  returnExchangeId String
  variantId        String
  quantity         Int            @default(1)
  returnExchange   ReturnExchange @relation(fields: [returnExchangeId], references: [id])
  variant          ProductVariant @relation(fields: [variantId], references: [id])
}

model ReturnExchange {
  id String @id @default(ulid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  orderItems       ReturnExchangeItem[]
  exchangeVariants ReturnExchangeVariant[]

  type                   ReturnExchangeType
  reason                 String?
  status                 ReturnExchangeStatus         @default(pending)
  shippingResponsibility ReturnShippingResponsibility @default(customer)

  priceDifference Decimal @default(0) @db.Decimal(10, 2)
  refundId        String?
  refund          Refund? @relation(fields: [refundId], references: [id], onDelete: SetNull)

  initiatedById String
  initiatedBy   User   @relation("ReturnExchangeInitiatedBy", fields: [initiatedById], references: [id], onDelete: Cascade)

  approvedById String?
  approvedBy   User?   @relation("ReturnExchangeApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([refundId])
  @@index([status])
}

model Shipment {
  id      String @id @default(ulid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  provider String
  service  String
  method   ShippingMethod @default(standard)

  rateId       String
  shippingRate ShippingRate? @relation(fields: [rateId], references: [id])

  trackingNumber String
  trackingUrl    String
  labelUrl       String
  metadata       Json

  status ShipmentStatus @default(pending)

  shippedAt   DateTime?
  deliveredAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([orderId])
  @@index([trackingNumber])
  @@index([provider, trackingNumber])
}

model ShippingRate {
  id       String         @id @default(cuid())
  provider String
  service  String
  method   ShippingMethod @default(standard)

  originCity      String?
  destinationCity String

  minWeight Decimal @db.Decimal(10, 2)
  maxWeight Decimal @db.Decimal(10, 2)

  minVolume Decimal @db.Decimal(10, 2)
  maxVolume Decimal @db.Decimal(10, 2)

  baseRate     Decimal @db.Decimal(10, 2)
  perKgRate    Decimal @db.Decimal(10, 2)
  deliveryTime String

  currencyId String
  currency   Currency @relation(fields: [currencyId], references: [id], onDelete: NoAction)

  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  shipments Shipment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([provider])
  @@index([destinationCity])
  @@index([isActive])
  @@index([method])
}

model TaxRate {
  id                String  @id @default(ulid())
  country           String
  region            String?
  name              String
  rate              Decimal @db.Decimal(10, 2)
  description       String?
  isActive          Boolean @default(true)
  isDefault         Boolean @default(false)
  appliesToShipping Boolean @default(false)

  currencyId String
  currency   Currency @relation(fields: [currencyId], references: [id], onDelete: NoAction)

  categories Category[] @relation("CategoryTaxRates")
  order      Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([country, region])
  @@index([country])
}

model ProductEngagement {
  id              String         @id @default(cuid())
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId       String
  product         Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId       String
  variant         ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  type            EngagementType
  quantity        Int?
  priceAtAddition Decimal?       @db.Decimal(10, 2)
  metadata        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId, variantId, type])
  @@index([type])
}

model Review {
  id        String         @id @default(ulid())
  userId    String?
  user      User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  productId String
  product   Product        @relation(fields: [productId], references: [id], onDelete: NoAction)
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: NoAction)

  rating  Int
  title   String?
  comment String?
  status  ReviewStatus @default(pending)
  images  String[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([userId, productId, variantId])
  @@index([userId])
  @@index([productId])
  @@index([rating])
  @@index([status])
  @@index([productId, status])
  @@index([userId, productId])
  @@index([userId, productId, rating])
}

model Coupon {
  id           String     @id @default(ulid())
  code         String     @unique
  name         String
  description  String?
  type         CouponType
  value        Decimal    @db.Decimal(10, 2)
  startDate    DateTime
  endDate      DateTime
  usageLimit   Int
  usedCount    Int        @default(0)
  perUserLimit Int        @default(1)
  minPurchase  Decimal?   @db.Decimal(10, 2)
  isActive     Boolean    @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  userCoupons UserCoupon[]

  @@index([code, endDate])
}

model UserCoupon {
  id       String @id @default(ulid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  couponId String
  coupon   Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  usedAt    DateTime?
  isApplied Boolean   @default(false)

  orders Order[]

  @@index([userId, couponId])
}

model Notification {
  id        String             @id @default(cuid())
  userId    String
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String?
  message   String?
  purpose   String
  metadata  Json?
  status    NotificationStatus @default(pending)
  sentAt    DateTime?
  readAt    DateTime?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([userId])
  @@index([userId, readAt])
}

model LoyaltyRule {
  id             String        @id @default(ulid())
  action         LoyaltyAction
  points         Int
  ratio          Decimal?      @db.Decimal(10, 2)
  minOrderAmount Decimal?      @db.Decimal(10, 2)
  maxPoints      Int?
  expiresInDays  Int?
  isActive       Boolean       @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([action])
  @@index([isActive])
}

model LoyaltyPointTransaction {
  id          String                 @id @default(ulid())
  userId      String
  user        User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  points      Int
  type        LoyaltyTransactionType
  action      LoyaltyAction
  note        String?
  referenceId String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  expiresAt   DateTime?

  @@index([userId])
  @@index([type])
  @@index([action])
  @@index([userId, type])
}

model UserPreference {
  id     String @id @default(ulid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // UI & Experience
  themeMode   ThemeType @default(system)
  compactMode Boolean   @default(false)

  // Communication
  newsletter        Boolean @default(true)
  smsNotifications  Boolean @default(false)
  pushNotifications Boolean @default(false)

  // Privacy / Security
  dataSharingConsent Boolean @default(true)

  // Personalization
  languageRegion String?
  currency       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  @@index([userId])
}

model Setting {
  id String @id @default(ulid())

  // Store Info
  storeName        String
  storeDescription String?
  storeLogo        String?
  storeEmail       String?
  storePhone       String?
  facebookUrl      String?
  instagramUrl     String?
  tiktokUrl        String?
  twitterUrl       String?

  // Shipping / Inventory
  freeShippingThreshold Decimal? @db.Decimal(10, 2)
  lowStockThreshold     Int      @default(5)

  // Reviews & Notifications
  autoApproveReviews Boolean @default(false)

  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?

  // Optional feature toggles
  loyaltyEnabled    Boolean @default(false)
  loyaltyPointValue Decimal @default(0.01) @db.Decimal(10, 2)
  couponsEnabled    Boolean @default(true)
  wishlistEnabled   Boolean @default(true)

  // Audit Log Retention (in days)
  auditRetentionDays Int @default(365)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
